<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIBAPER 26 - Dual View Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4361ee; --success: #2ecc71; --warning: #f1c40f; --danger: #e74c3c; --bg: #f4f7fe; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        
        /* --- LAYOUT UMUM --- */
        body.liquid-bg { 
            background: linear-gradient(-45deg, #0f2027, #2c5364, #203a43, #23d5ab); 
            background-size: 400% 400%; animation: liquid 15s ease infinite; 
            min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        @keyframes liquid { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }

        .glass-card { 
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); 
            border-radius: 25px; padding: 35px; width: 100%; max-width: 420px; 
            border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; color: white; 
        }

        .hidden { display: none !important; }
        input, select { width: 100%; padding: 14px; border-radius: 12px; border: none; margin-bottom: 12px; background: rgba(255,255,255,0.2); color: white; outline: none; }
        select option { background: #2c5364; color: white; }
        .btn-primary { background: white; color: #2c5364; font-weight: bold; padding: 15px; border-radius: 12px; border: none; cursor: pointer; width: 100%; transition: 0.3s; }

        /* --- DASHBOARD ADMIN (HYBRID LAYOUT) --- */
        #pageAdmin { background: var(--bg); display: none; width: 100vw; height: 100vh; overflow: hidden; }

        /* Sidebar: Default Desktop (Kiri) */
        .sidebar { 
            width: 280px; background: white; padding: 30px 20px; 
            display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.05); 
        }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }

        /* Grid Statistik: Desktop (4 Kolom) */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }

        /* Layout Data: Desktop (Kiri Tabel, Kanan Chart) */
        .data-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .box { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.02); }

        /* Table Desktop */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #aaa; font-size: 0.75rem; padding: 12px; border-bottom: 2px solid #f8f9fa; }
        td { padding: 12px; border-bottom: 1px solid #f8f9fa; font-size: 0.85rem; }
        .badge { padding: 5px 12px; border-radius: 10px; color: white; font-size: 0.7rem; font-weight: bold; }
        .hadir { background: var(--success); } .izin { background: var(--warning); color: #333; } .sakit { background: var(--danger); }

        /* --- RESPONSIVE SETTINGS (MODE HP) --- */
        @media (max-width: 900px) {
            #pageAdmin { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { width: 100%; padding: 15px; border-bottom: 1px solid #eee; height: auto; }
            .sidebar h2 { font-size: 1.2rem; text-align: center; margin-bottom: 15px !important; }
            
            .stat-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .data-layout { grid-template-columns: 1fr; } /* Tumpuk vertikal */
            
            /* Sembunyikan Tabel, Ganti ke List gaya HP */
            .box-table { padding: 15px; }
            table thead { display: none; } /* Sembunyikan header tabel di HP */
            tr { display: flex; flex-direction: column; padding: 10px 0; border-bottom: 1px solid #f0f0f0; position: relative; }
            td { border: none; padding: 4px 0; }
            td:nth-child(1) { font-weight: bold; font-size: 1rem; color: #333; } /* Nama */
            td:nth-child(2) { position: absolute; right: 0; top: 15px; } /* Badge Status */
            td:nth-child(3) { color: #999; font-size: 0.7rem; } /* Jam */
            
            .main-content { padding: 15px; }
        }
    </style>
</head>
<body id="mainBody" class="liquid-bg">

    <div id="pageLanding" class="glass-card">
        <h1>SIBAPER</h1>
        <p style="letter-spacing: 2px; font-size: 0.7rem; margin-bottom: 35px;">SISTEM MONITORING ABSENSI 26</p>
        <button class="btn-primary" onclick="showPage('pageSiswa')" style="margin-bottom: 15px;">ABSENSI SEBAGAI SISWA</button>
        <button class="btn-primary" style="background:none; color:white; border:1px solid white;" onclick="showPage('pageLoginAdmin')">LOGIN SEBAGAI ADMIN</button>
    </div>

    <div id="pageSiswa" class="glass-card hidden">
        <h2>SISWA ABSEN</h2>
        <p id="statusGPS" style="font-size: 0.8rem; margin: 15px 0; color: #ffeb3b; font-weight: bold;">üîí Cek Lokasi GPS...</p>
        <form id="formAbsen">
            <input type="text" name="nama" placeholder="Nama Lengkap" required>
            <select name="keterangan" required>
                <option value="" disabled selected>Pilih Status</option>
                <option value="Hadir">Hadir</option>
                <option value="Izin">Izin</option>
                <option value="Sakit">Sakit</option>
            </select>
            <button type="submit" id="btnKirim" class="btn-primary" style="opacity:0.5;" disabled>KIRIM KEHADIRAN</button>
        </form>
        <p onclick="showPage('pageLanding')" style="margin-top:20px; cursor:pointer; font-size:0.8rem;">‚Üê Kembali</p>
    </div>

    <div id="pageLoginAdmin" class="glass-card hidden">
        <h2>ADMIN LOGIN</h2>
        <input type="text" id="userAdmin" placeholder="Username">
        <input type="password" id="passAdmin" placeholder="Password">
        <button class="btn-primary" onclick="doLogin()">MASUK DASHBOARD</button>
    </div>

    <div id="pageAdmin">
        <div class="sidebar">
            <h2 style="color: var(--primary); margin-bottom: 30px;">SIBAPER 26</h2>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
                <span style="font-size: 0.7rem; color: #aaa; font-weight: bold; display: block; margin-bottom: 8px;">KONTROL DATA</span>
                <input type="date" id="filterTanggal" onchange="ambilData()" style="background:white; color:#333; padding:10px; border:1px solid #ddd; margin-bottom: 8px;">
                <input type="text" id="cariNama" onkeyup="cariSiswa()" placeholder="Cari nama..." style="background:white; color:#333; padding:10px; border:1px solid #ddd;">
                <button onclick="downloadCSV()" style="width:100%; background:var(--success); color:white; border:none; padding:10px; border-radius:10px; font-weight:bold; cursor:pointer; margin-top:10px;">üì• Download CSV</button>
            </div>
            <button onclick="location.reload()" style="margin-top:auto; background:#fff1f2; color:#e11d48; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer;">LOGOUT</button>
        </div>

        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 id="judulContent">Dashboard Utama</h2>
                <div id="tglLabel" style="font-weight: bold; color: var(--primary);"></div>
            </div>

            <div class="stat-grid">
                <div class="stat-card"><h3>Total</h3><h2 id="txtTotal">0</h2></div>
                <div class="stat-card"><h3>Hadir</h3><h2 id="txtHadir" style="color: var(--success);">0</h2></div>
                <div class="stat-card"><h3>Izin</h3><h2 id="txtIzin" style="color: var(--warning);">0</h2></div>
                <div class="stat-card"><h3>Sakit</h3><h2 id="txtSakit" style="color: var(--danger);">0</h2></div>
            </div>

            <div class="data-layout">
                <div class="box box-table">
                    <h3>Daftar Absensi (A-Z)</h3>
                    <table>
                        <thead>
                            <tr><th>NAMA SISWA</th><th>STATUS</th><th>JAM</th><th>LOKASI</th></tr>
                        </thead>
                        <tbody id="isiTabel"></tbody>
                    </table>
                </div>
                <div class="box" id="boxChart" style="text-align: center;">
                    <h3 style="margin-bottom: 20px;">Persentase (%)</h3>
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyij-D6Yvi80mf3OFZoBseGpKm3YOs2rQXMeesyeMmud4gB0iKKVTZMsCOPT2CcVCjwMA/exec';
        let lokasiSiswa = null;
        let chartInstance = null;

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterTanggal').value = today;
        };

        function getGPS() {
            const btn = document.getElementById('btnKirim');
            const status = document.getElementById('statusGPS');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((p) => {
                    lokasiSiswa = p.coords.latitude + "," + p.coords.longitude;
                    status.innerText = "‚úÖ GPS Terdeteksi!";
                    status.style.color = "#2ecc71";
                    btn.disabled = false; btn.style.opacity = "1";
                }, () => {
                    status.innerText = "‚ùå Wajib Aktifkan GPS!";
                    status.style.color = "#ff4757";
                }, { enableHighAccuracy: true });
            }
        }

        function showPage(id) {
            document.querySelectorAll('.glass-card').forEach(c => c.classList.add('hidden'));
            document.getElementById('pageAdmin').style.display = 'none';
            document.getElementById('mainBody').classList.add('liquid-bg');
            if(id === 'pageAdmin'){
                document.getElementById('pageAdmin').style.display = 'flex';
                document.getElementById('mainBody').classList.remove('liquid-bg');
            } else {
                document.getElementById(id).classList.remove('hidden');
                if(id === 'pageSiswa') getGPS();
            }
        }

        function doLogin() {
            if(document.getElementById('userAdmin').value === 'admin26' && document.getElementById('passAdmin').value === 'sibaper26'){
                showPage('pageAdmin'); ambilData();
            } else { alert("User/Pass Salah!"); }
        }

        document.getElementById('formAbsen').addEventListener('submit', e => {
            e.preventDefault();
            const btn = document.getElementById('btnKirim');
            btn.disabled = true; btn.innerText = "Mengirim...";
            let fd = new FormData(e.target);
            fd.append('lokasi', lokasiSiswa);
            fetch(scriptURL, { method: 'POST', body: fd }).then(() => { alert("Sukses!"); location.reload(); });
        });

        async function ambilData() {
            const res = await fetch(scriptURL);
            let rawData = await res.json();
            const filterDate = document.getElementById('filterTanggal').value;
            document.getElementById('tglLabel').innerText = new Date(filterDate).toLocaleDateString('id-ID', {day:'numeric', month:'short'});

            let data = rawData.filter(r => new Date(r[2]).toISOString().split('T')[0] === filterDate);
            data.sort((a,b) => a[0].localeCompare(b[0]));

            const tbody = document.getElementById('isiTabel');
            tbody.innerHTML = '';
            let h=0, i=0, s=0;

            if(data.length === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#aaa;">Data Kosong.</td></tr>';

            data.forEach(r => {
                const st = r[1].toLowerCase();
                if(st==='hadir') h++; else if(st==='izin') i++; else if(st==='sakit') s++;
                const jam = new Date(r[2]).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                const mapLink = (r[3] && r[3].includes(',')) 
                    ? `<a href="https://www.google.com/maps?q=${r[3]}" target="_blank" style="color:var(--primary); font-weight:bold; text-decoration:none;">üìç Maps</a>`
                    : `<span>-</span>`;
                
                const tr = document.createElement('tr');
                tr.className = "row-siswa";
                tr.innerHTML = `<td class="nm">${r[0]}</td>
                                <td><span class="badge ${st}">${r[1]}</span></td>
                                <td>${jam} WIB</td>
                                <td>${mapLink}</td>`;
                tbody.appendChild(tr);
            });

            document.getElementById('txtTotal').innerText = data.length;
            document.getElementById('txtHadir').innerText = h;
            document.getElementById('txtIzin').innerText = i;
            document.getElementById('txtSakit').innerText = s;

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(document.getElementById('myChart'), {
                type: 'doughnut',
                data: { labels: ['Hadir','Izin','Sakit'], datasets:[{data:[h,i,s], backgroundColor:['#2ecc71','#f1c40f','#e74c3c'], borderWidth:0}]},
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        function cariSiswa() {
            let k = document.getElementById('cariNama').value.toLowerCase();
            document.querySelectorAll('.row-siswa').forEach(row => {
                row.style.display = row.querySelector('.nm').innerText.toLowerCase().includes(k) ? "" : "none";
            });
        }

        function downloadCSV() {
            let csv = "Nama,Status,Waktu\n";
            document.querySelectorAll("#isiTabel tr").forEach(row => {
                const cols = row.querySelectorAll("td");
                if(cols.length > 1) csv += `${cols[0].innerText},${cols[1].innerText},${cols[2].innerText}\n`;
            });
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Rekap_${document.getElementById('filterTanggal').value}.csv`;
            a.click();
        }
    </script>
</body>
</html>
